# 内网穿透

## 原理
处于局域网内的服务器，因为隔着路由器，服务器不能被公网发现。
(假设路由器不能有用户控制，不能配置端口映射，路由器的公网ip也是变化的)

角色：
- 内网服务器S1:inet_ip1:port1，S2:inet_ip2:port2
- 路由器R: pub_ip,inet_ip
- 代理桥接服务器P1:proxy_ip1:port1
- 代理转接服务器P2:proxy_ip2:
    - 端口转接: P2:port1 -> S1, P2:port2 -> S2
- 客户电脑Ci: 访问P2:portn以触达内网服务器

原理解释：
- 内网服务器向P1:proxy_ip1:port1注册自己的服务地址
(在smarGate是在其客户端上配置内网的inet_ipn:portn, 
server端只以用户未感知的默认方式配置了router信息给smarGate官方服务器)。
- 代理桥接服务器由此得知内网的路由信息。后续桥接服务器只需要提供这个路由信息，
不走流量，没压力。(在smarGate上这个角色由smarGate官方提供，也是唯一必需
在公网可直接触达的)
- 代理转接服务器上配置了代理转接服务器端口到真实服务的端口映射。因此对代理转接服务器，
每一个内网服务需要消耗一个端口资源。转接服务器通过桥接服务器获得跟内网服务器
的p2p连接。(在smarGate上这个角色是smarGate client)
- 客户访问代理转接服务器的对应端口，通过转接服务器的代理方式间接的连接上内网服务。

## 使用smarGate
[常用服务穿透配置](https://github.com/lazy-luo/smarGate/wiki/常用服务穿透配置)

以一个无卡连内网的android手机为服务器，另一个连4g网络在外地的android手机为代理网关。
- 在服务器和代理手机上安装smarGate app
- 服务端S配置开启服务
- 客户端P2配置服务端的内网ip,port,本地映射端口
- 用户端连客户端P2:ip:portn以方位服务S

### 实测：
- ssh服务成功外网成功穿透，连接到内网
- ftp服务端有响应，但连接拒绝，可能是ftp服务器配置问题，
也可能是涉及多个端口的问题(因为服务器和客户机都处于内网，任何新暴露的端口
都不能被对方触达，所以ftp很可能是无法穿透的)。